<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choose Username</title>
   
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDFmufOx1aX_JMJsfeXMIzD0nGqQ1pSZIA",
    authDomain: "l-bodcast.firebaseapp.com",
    projectId: "l-bodcast",
    databaseURL: "https://l-bodcast-default-rtdb.firebaseio.com/",
    storageBucket: "l-bodcast.appspot.com",
    messagingSenderId: "1007184602665",
    appId: "1:1007184602665:web:dae80c9b3f208f5749de38",
    measurementId: "G-BX9F49FM08"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const usernameInput = document.getElementById("usernameInput");
const registerButton = document.getElementById("register");
const messageElement = document.getElementById("message");

// Get costume_id from URL params
const urlParams = new URLSearchParams(window.location.search);
const costumeId = urlParams.get('useruid');
const name = urlParams.get('name') || "";

document.getElementById("welcom").innerText = "Welcome " + name;

if (!costumeId) {
    messageElement.innerText = "Invalid user ID.";
}

(async function checkExistingUsername() {
    try {
        const usernameStatus = await get(ref(db, `users/${costumeId}/username`));
        if (usernameStatus.exists()) {
            window.location.href = 'index.html';
        }
    } catch (error) {
        console.error("Error checking existing username:", error);
    }
})();

registerButton.disabled = true; // Disable button initially

registerButton.addEventListener('click', async () => {
    const username = usernameInput.value.trim();
    
    if (usernameInput.classList.contains("valid")) {
        const usernameRef = ref(db, `usernames/${username}`);
        const userRef = ref(db, `users/${costumeId}`);

        try {
            await set(usernameRef, { "username": username });
            await update(userRef, { username: username });
            window.location.href = "index.html";
        } catch (error) {
            console.error("Error:", error);
            messageElement.innerText = "An error occurred. Try again.";
        }
    }
});

async function isUsernameTaken() {
    const username = usernameInput.value.trim();
    if (!username) return;

    const usernameRef = ref(db, `usernames/${username}`);

    try {
        const snapshot = await get(usernameRef);
        if (snapshot.exists()) {
            messageElement.innerText = "Username is already taken.";
            usernameInput.classList.remove("valid");
            usernameInput.classList.add("invalid");
        } else {
            messageElement.innerText = "";
            usernameInput.classList.remove("invalid");
            usernameInput.classList.add("valid");
        }
        toggleRegisterButton();
    } catch (error) {
        console.error("Error checking username:", error);
        messageElement.innerText = "An error occurred. Try again.";
    }
}

function isValidName(name) {
    const regex = /^[^\s@#$%^&*()+={}\[\]<>?/\\|~.]+$/;
    return regex.test(name);
}

function toggleRegisterButton() {
    registerButton.disabled = usernameInput.classList.contains("invalid") || usernameInput.value.trim() === "";
}

usernameInput.addEventListener("input", () => {
    const username = usernameInput.value.trim();

    if (isValidName(username)) {
        usernameInput.classList.remove("invalid");
        usernameInput.classList.add("valid");
        isUsernameTaken();
    } else if (username === "") {
        usernameInput.classList.remove("valid", "invalid");
        messageElement.innerText = "";
    } else {
        usernameInput.classList.remove("valid");
        usernameInput.classList.add("invalid");
        messageElement.innerText = "Don't use spaces or special characters.";
    }
    toggleRegisterButton();
});

    </script>


</head>
<body>
    <img class="logo" src="https://i.ibb.co/yb859P9/icon-1.png" alt="L'BODCAST Logo">
    <h2 id="welcom"></h2>
    <h2>Choose Your Username</h2>
    <input type="name" id="usernameInput" placeholder="Enter username">
    <p id="message"></p>
    <button id="register">Register</button>
    


    <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');

        *{
    font-family: "Poppins", serif;
    margin: 0;

    padding: 0;
    color: white;

}
        body{
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            gap: 10px;
            background-color: black;
        }

        .logo{
    width: 200px;
    height: 200px;
    position: relative;
    bottom: -5px;

}
        input{
            padding: 15px;
            border: 2px solid white ;
            border-radius: 7px;
            background-color:transparent;
            color: white;
          
           width: 300px;
            background-size: 20px;
            background-repeat: no-repeat;
            background-position: 90%;
            transition: .3s;
            

        }
        
        input:focus{
            border: 4px solid white;
            outline: none;
            transition: .3s ;
            padding: 15px;
            
        }
        .invalid:not(:placeholder-shown) , #email:invalid:not(:placeholder-shown)  {
            border-color: red;
           /* background-image: url(/red.png);*/
            box-shadow: 1px -1px 20px 2px rgb(245, 4, 8 , 0.3);
            transition: .3s;
            
         
           
        }
        
        .valid:not(:placeholder-shown)  , #email:valid:not(:placeholder-shown) {
            border-color: rgba(48, 245, 4, 0.3);
          /*  background-image: url(/green.png);*/
            box-shadow: 1px -1px 20px 2px rgba(48, 245, 4, 0.3);
            transition: .3s;

        }

        #message{
            color: rgb(255, 91, 91);
            font-size: 12px;
        }

        button{
            padding: 15px;
            border: 4px solid white;
            border-radius: 7px;
            
            color:white;
            background-color: black;
            font-weight: 600;
            width: 65%;
            transition: all.3s;
        }
        button:hover{
            transition: all.3s;
            background-color:white;
            color: #222222;
            box-shadow: 1px -1px 20px 2px white;

        }

        button:disabled {
            border: 4px solid red;
            color: red;
            background-color: transparent;
   
}

button:disabled:hover {
            border: 4px solid red;
            color: red;
            box-shadow: 1px -1px 20px 2px red;
            background-color: transparent;


   
}

button:not(:disabled) {
    border: 4px solid green;
    color: green;
    background-color: transparent;
    cursor: pointer; /* Ensures it looks interactive */
}

button:not(:disabled):hover {
    border: 4px solid green;
    color: green;
    background-color: transparent;
    box-shadow: 1px -1px 20px 2px green;
}




    </style>

    <script>
         


    </script>
</body>
</html>
