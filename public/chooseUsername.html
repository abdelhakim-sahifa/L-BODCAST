<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choose Username</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase configuration
         const firebaseConfig = {
        apiKey: "AIzaSyDFmufOx1aX_JMJsfeXMIzD0nGqQ1pSZIA",
        authDomain: "l-bodcast.firebaseapp.com",
        projectId: "l-bodcast",
        databaseURL: "https://l-bodcast-default-rtdb.firebaseio.com/", // Replace with your Realtime Database URL
        storageBucket: "l-bodcast.appspot.com",  // Fixed URL
        messagingSenderId: "1007184602665",
        appId: "1:1007184602665:web:dae80c9b3f208f5749de38",
        measurementId: "G-BX9F49FM08"
    };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
    const usernameinpt = document.getElementById("usernameInput")

        const register = document.getElementById('register')
        // Get costume_id from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const costumeId = urlParams.get('useruid');
        if (!costumeId) {
            document.getElementById("message").innerText = "Invalid user ID.";
        }

        const usernameStatue = await get(ref(db ,`users/${costumeId}/username` ));
        if(usernameStatue.exists()){
            window.location.href = 'index.html'
        }

        register.addEventListener('click' ,
            async()=>{
                const username = usernameinpt.value ;
               if(usernameinpt.classList[0] == 'valid'){
                const usernameRef = ref(db, `usernames/${username}`);
                const userRef = ref(db, `users/${costumeId}`);
                try {
                    await set(usernameRef, { "username" : username }); // Ensure proper storage in /usernames
                    await update(userRef, { username: username }); // Store username in /users/[costume_id]
            window.location.href = "index.html"
                
                } catch (error) {
                        console.error("Error :", error);
                        document.getElementById("message").innerText = "An error occurred. Try again.";
                    }
               }

               
            }
        )

        window.checkUsername = async function () {
            const username = document.getElementById("usernameInput").value.trim();
            if (!username) {
                document.getElementById("message").innerText = "Please enter a username.";
                return;
            }

            const usernameRef = ref(db, `usernames/${username}`);
            const userRef = ref(db, `users/${costumeId}`);

            try {
                const snapshot = await get(usernameRef);
                if (snapshot.exists()) {
                    document.getElementById("message").innerText = "Username is already taken.";
                } else {
                    await set(usernameRef, { "username" : username }); // Ensure proper storage in /usernames
                    await update(userRef, { username: username }); // Store username in /users/[costume_id]
                    document.getElementById("message").innerText = "Username registered successfully!";
                }
            } catch (error) {
                console.error("Error checking username:", error);
                document.getElementById("message").innerText = "An error occurred. Try again.";
            }
        };
  
        async function isUsernameTaken(){
    const username = document.getElementById("usernameInput").value.trim();
            

            const usernameRef = ref(db, `usernames/${username}`);

            try {
                const snapshot = await get(usernameRef);
                
                if (snapshot.exists()) {
                    document.getElementById("message").innerText = "Username is already taken.";
                    usernameinpt.className = 'invalid';


                } else {
                  
                    document.getElementById("message").innerText = "";
                    usernameinpt.className = 'valid';

                
                }

            } catch (error) {
                console.error("Error checking username:", error);
                document.getElementById("message").innerText = "An error occurred. Try again.";
            }
}

document.getElementById("usernameInput").addEventListener('input'
        ,

        function( ){
           var  usernameInput = document.getElementById('usernameInput') ;
            if(isValidName(usernameInput.value) ){

                usernameInput.className = 'valid';
                isUsernameTaken()


            }
            else if (usernameInput.value == ''){
                usernameInput.remove = 'invalid';
                usernameInput.remove = 'valid';

            }
            else{
                usernameInput.className = 'invalid';
                document.getElementById("message").innerText = "Don't use spaces or special characters";

               


            }
        }
    )

    function isValidName(name) {
    const regex = /^[^\s@#$%^&*()+={}[\]<>?/\\|`~]+$/;
    if (!regex.test(name)) {
       
        return false;
    }
    return true;
}




   </script>
</head>
<body>
    <img class="logo" src="https://i.ibb.co/yb859P9/icon-1.png" alt="L'BODCAST Logo">
    <h2>Choose Your Username</h2>
    <input type="name" id="usernameInput" placeholder="Enter username">
    <p id="message"></p>
    <button id="register">Register</button>
    


    <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');

        *{
    font-family: "Poppins", serif;
    margin: 0;

    padding: 0;
    color: white;

}
        body{
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            gap: 10px;
            background-color: black;
        }

        .logo{
    width: 200px;
    height: 200px;
    position: relative;
    bottom: -5px;

}
        input{
            padding: 15px;
            border: 2px solid white ;
            border-radius: 7px;
            background-color:transparent;
            color: white;
          
           width: 300px;
            background-size: 20px;
            background-repeat: no-repeat;
            background-position: 90%;
            transition: .3s;
            

        }
        
        input:focus{
            border: 4px solid white;
            outline: none;
            transition: .3s ;
            padding: 15px;
            
        }
        .invalid:not(:placeholder-shown) , #email:invalid:not(:placeholder-shown)  {
            border-color: red;
           /* background-image: url(/red.png);*/
            box-shadow: 1px -1px 20px 2px rgb(245, 4, 8 , 0.3);
            transition: .3s;
            
         
           
        }
        
        .valid:not(:placeholder-shown)  , #email:valid:not(:placeholder-shown) {
            border-color: rgba(48, 245, 4, 0.3);
          /*  background-image: url(/green.png);*/
            box-shadow: 1px -1px 20px 2px rgba(48, 245, 4, 0.3);
            transition: .3s;

        }

        #message{
            color: rgb(255, 91, 91);
            font-size: 12px;
        }

        button{
            padding: 15px;
            border: 4px solid white;
            border-radius: 7px;
            
            color:white;
            background-color: black;
            font-weight: 600;
            width: 65%;
            transition: all.3s;
        }
        button:hover{
            transition: all.3s;
            background-color:white;
            color: #222222;
            box-shadow: 1px -1px 20px 2px white;

        }
    </style>

    <script>
         


    </script>
</body>
</html>
